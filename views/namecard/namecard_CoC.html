<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG COC角色卡</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- NEW: Include SortableJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --gradient-start: #60a5fa;
            --gradient-end: #f472b6;
            --message-bg: linear-gradient(to right, #d7ffec, #cae1ff);
            --status-bg: linear-gradient(to right, #cae1ff, #d7ffec);
            --container-bg: linear-gradient(to right, #b5e1fe, #f3f7ff);
            --card-bg: linear-gradient(to right, #ffffff, #ffffff);
            --text-color: #1e40af;
            --attribute-color: #4a5568;
            --subtext-color: #6b7280;
            --border-radius: 0.5rem;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, #516ea7, #d6e4ff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background: var(--container-bg);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .column {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .column:hover {
            transform: translateY(-5px);
        }

        h2 {
            color: #b83b6f;
            margin-bottom: 1rem;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            text-decoration: underline;
            /* Add underline */
        }

        h3 {
            color: #4c51bf;
            margin-bottom: 1rem;
            text-align: center;
        }

        .avatar-container {
            width: 12rem;
            height: 12rem;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 5px solid #ffffff;
            /* Add border */
        }

        .stats-chart {
            margin-top: 1.5rem;
        }

        .message {
            background: var(--message-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .player-info {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .player-info span {
            color: var(--subtext-color);
        }

        .status-bars {
            margin-top: 1.5rem;
            background: var(--status-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            font-weight: bold;
            color: var(--text-color);
        }

        .progress-bar {
            flex: 1;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 9999px;
            margin: 0 1rem;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            border-radius: 9999px;
        }

        .attribute-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between !important;
            margin-bottom: 0.1rem;
        }

        .attribute {
            flex: 0 1 30%;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            font-weight: bold;
            color: var(--attribute-color);
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flex-item {
            flex: 1 1 30%;
            margin: 0.5rem;
            text-align: center;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 1rem 0;
        }

        .icon {
            margin-right: 0.5rem;
            color: var(--text-color);
        }

        /* Added button styles */
        #editBtn {
            background: linear-gradient(to right, #60a5fa, #f472b6);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
            margin-bottom: 1rem;
        }

        #editBtn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        input[type="text"] {
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
            outline: none;
        }

        /* NEW: Cursor change for draggable items */
        .draggable {
            cursor: grab;
        }

        .draggable:active {
            cursor: grabbing;
        }

        /* NEW: Drag visual feedback styles */
        .sortable-chosen {
            background-color: rgba(96, 165, 250, 0.2);
            border: 2px dashed #60a5fa;
        }

        .sortable-ghost {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Added Edit button -->
        <button id="editBtn" onclick="toggleEditMode()">編輯角色</button>
        <div class="grid">
            <div class="column">
                <div class="player-info">
                    <!-- Wrap editable fields in identifiable elements -->
                    <h2 id="characterName">角色名字</h2>
                    <div class="info flex-container">
                        <span class="flex-item" id="playerName">玩家名字</span>
                        <span class="flex-item" id="characterID">角色ID</span>
                    </div>
                </div>
                <div class="avatar-container">
                    <img id="avatarImage" src="https://d1vzi28wh99zvq.cloudfront.net/images/21286/483040.jpg"
                        alt="角色頭像">
                </div>
                <h3 id="attributeTitle">基本屬性</h3>
                <div id="basic-attributes"></div>
            </div>

            <div class="column">
                <h3 id="skillsTitle">技能類型</h3>
                <canvas id="skillsChart"></canvas>

                <div class="status-bars">
                    <h3>性格與偏好</h3>
                    <div class="status-item">
                        <i class="fas fa-check icon"></i>
                        <span>事前準備</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 70%"></div>
                        </div>
                        <span>隨機應變</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-star icon"></i>
                        <span>單一專業</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 60%"></div>
                        </div>
                        <span>多項才藝</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-users icon"></i>
                        <span>邊緣人</span>
                        <div class="progress-bar">
                            <div class="progress" style="width: 85%"></div>
                        </div>
                        <span>社牛</span>
                    </div>
                </div>
            </div>

            <div class="column">
                <h3 id="diceTitle">擲骰</h3>
                <div id="dice-rolls"></div>
                <div class="divider"></div>
                <div class="message">
                    <h3 id="notesTitle">筆記</h3>
                    <div id="notes"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const icons = [
            'fas fa-check',
            'fas fa-star',
            'fas fa-heart',
            'fas fa-smile',
            'fas fa-thumbs-up',
            'fas fa-lightbulb',
            'fas fa-user-friends',
            'fas fa-flag',
            'fas fa-clipboard-list',
            'fas fa-comment-dots'
        ];
        const avatarImageUrl = "https://images2.imgbox.com/df/86/GVcHJFVv_o.png";

        const character = {
            characterName: "傑克·史密斯",
            playerName: "D&D",
            id: "@DD",
            attributes: {
                attributesList: {
                    HP: "15 / 15",
                    MP: "0 / 0",
                    san: "60 / 60 ",
                    幸運: 80,
                    力量: 0,
                    敏捷: 0,
                    意志: 1,
                    體質: 0,
                    外貌: 0,
                    教育: 0,
                    體型: 0,
                    智力: 0,
                    靈感: 0,
                    體格: -2,
                    DB: -2,
                    MOV: 8
                }
            },
            skills: [
                { type: '交際', value: 50 },
                { type: '學問', value: 80 },
                { type: '職業', value: 40 },
                { type: '調查+隱密', value: 60 },
                { type: '戰鬥', value: 100 },
                { type: '醫療', value: 20 }
            ],
            diceRolls: {
                心理學: "50",
                信譽: "30",
                偵查: "25",
                鬥毆: "15"
            },
            notes: {
                title: "筆記",
                items: [
                    { label: "現金", value: "1,000日元" },
                    { label: "隨身物品", value: "筆記：這是測試,請試試在群組輸入 .char use Sad" },
                    { label: "心靈支柱", value: "無" },
                    { label: "資產", value: "物品：" }
                ]
            },
            diceTitle: "擲骰", // 新增擲骰標題
            skillsTitle: "技能類型", // 新增技能類型標題
            attributeTitle: "基本屬性",
            personalityPreferencesTitle: '性格與偏好',
            personalityPreferences: {
                items: [
                    { label: '事前準備', value: 80, alternative: '隨機應變', icon: icons[0] },
                    { label: '單一專業', value: 60, alternative: '多項才藝', icon: icons[1] },
                    { label: '邊緣人', value: 85, alternative: '社牛', icon: icons[2] }
                ]
            }

        };

        document.getElementById('playerName').innerText = character.playerName;
        document.getElementById('characterName').innerText = character.characterName;
        document.getElementById('characterID').innerText = character.id;
        document.getElementById('avatarImage').src = avatarImageUrl;

        // 更新技能類型標題
        document.getElementById('skillsTitle').innerText = character.skillsTitle;

        // 更新基本屬性標題
        document.getElementById('attributeTitle').innerText = character.attributeTitle;
        // 更新擲骰標題
        document.getElementById('diceTitle').innerText = character.diceTitle;

        // 更新筆記標題
        document.getElementById('notesTitle').innerText = character.notes.title;

        // 生成筆記的 HTML
        const notesHTML = character.notes.items.map(item => {
            return `<p>${item.label}：<span style="color: var(--text-color);">${item.value}</span></p>`;
        }).join('');
        document.getElementById('notes').innerHTML = notesHTML;



        // 生成性格與偏好的 HTML
        const statusItemsHTML = character.personalityPreferences.items.map(item => {
            return `
                <div class="status-item">
                    <i class="${item.icon} icon"></i>
                    <span>${item.label}</span>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${item.value}%"></div>
                    </div>
                    <span>${item.alternative}</span>
                </div>
            `;
        }).join('');

        // 替換原有的性格與偏好內容
        document.querySelector('.status-bars').innerHTML = `
            <h3>${character.personalityPreferencesTitle}</h3>
            ${statusItemsHTML}
        `;

        const attributes = character.attributes;
        const attributesHTML = `
            <div class="attribute-group">
                ${Object.entries(attributes.attributesList).map(([key, value]) => {
            return `<span class="attribute">${key}：<span style="color: var(--text-color);">${value}</span></span>`;
        }).join('')}
            </div>
        `;
        document.getElementById('basic-attributes').innerHTML = attributesHTML;

        const diceRollsHTML = `
            <div class="attribute-group">
                ${Object.entries(character.diceRolls).map(([key, value]) => {
            return `<span class="attribute">${key}：<span style="color: var(--text-color);">${value}</span></span>`;
        }).join('')}
            </div>
        `;
        document.getElementById('dice-rolls').innerHTML = diceRollsHTML;

        const ctx = document.getElementById('skillsChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: character.skills.map(skill => skill.type),
                datasets: [{
                    data: character.skills.map(skill => skill.value),
                    backgroundColor: 'rgba(255, 105, 180, 0.3)',
                    borderColor: 'rgba(255, 105, 180, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(255, 105, 180, 1)'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        pointLabels: {
                            color: '#4a5568',
                            font: {
                                size: 12
                            }
                        },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Centering logic for player name and character ID
        const playerNameEl = document.getElementById('playerName');
        const characterIDEl = document.getElementById('characterID');

        if (!character.playerName) {
            playerNameEl.style.display = 'none';
            characterIDEl.style.textAlign = 'center';
            characterIDEl.style.width = '100%'; // Force full width
        } else if (!character.id) {
            characterIDEl.style.display = 'none';
            playerNameEl.style.textAlign = 'center';
            playerNameEl.style.width = '100%'; // Force full width
        }

        // New editing functionality
        let isEditMode = false;
        function toggleEditMode() {
            if (!isEditMode) {
                isEditMode = true;
                renderEditForm();
            } else {
                // In this design, the "保存修改" button calls saveEdit()
            }
        }

        // NEW: In renderEditForm, convert attributes and diceRolls if needed
        function renderEditForm() {
            // Convert attributesList to array if still an object
            if (!Array.isArray(character.attributes.attributesList)) {
                character.attributes.attributesList = Object.entries(character.attributes.attributesList).map(([key, value]) => ({ key, value }));
            }
            // Convert diceRolls to array if still an object
            if (!Array.isArray(character.diceRolls)) {
                character.diceRolls = Object.entries(character.diceRolls).map(([key, value]) => ({ key, value }));
            }
            document.querySelector('.container').innerHTML = `
  <h2>編輯角色資料</h2>
  <div>
    <label>角色名字: <input type="text" id="editCharacterName" value="${character.characterName}"></label>
    <label>玩家名字: <input type="text" id="editPlayerName" value="${character.playerName}"></label>
    <label>角色ID: <input type="text" id="editCharacterID" value="${character.id}"></label></br>
    <label>頭像網址: <input type="text" id="editAvatar" value="${document.getElementById('avatarImage').src}"></label>
  </div>
  <hr>
  <div>
    <h3>基本屬性</h3>
    <div id="editAttributesContainer">
      <div id="editAttributesList">
        ${character.attributes.attributesList.map(attr =>
                `<div draggable="true" class="draggable">
          <input type="text" class="attr-key" value="${attr.key}">
          : <input type="text" class="attr-value" value="${attr.value}">
          <button onclick="removeAttr('${attr.key}')">移除</button>
        </div>`
            ).join('')}
      </div>
      <button onclick="addAttribute()">新增屬性</button>
    </div>
  </div>
  <hr>
  <div>
    <h3>技能</h3>
    <div id="editSkillsContainer">
      <div id="editSkillsList">
        ${character.skills.map((skill, index) =>
                `<div draggable="true" class="draggable">
          <input type="text" class="skill-type" value="${skill.type}">
          <input type="number" class="skill-value" value="${skill.value}">
          <button onclick="removeSkill(${index})">移除</button>
        </div>`
            ).join('')}
      </div>
      <button onclick="addSkill()">新增技能</button>
    </div>
  </div>
  <hr>
  <div>
    <h3>擲骰</h3>
    <div id="editDiceRollsContainer">
      <div id="editDiceRollsList">
        ${character.diceRolls.map(dice =>
                `<div draggable="true" class="draggable">
          <input type="text" class="dice-key" value="${dice.key}">
          : <input type="text" class="dice-value" value="${dice.value}">
          <button onclick="removeDice('${dice.key}')">移除</button>
        </div>`
            ).join('')}
      </div>
      <button onclick="addDice()">新增擲骰</button>
    </div>
  </div>
  <hr>
  <div>
    <h3>筆記</h3>
    <label>筆記標題: <input type="text" id="editNotesTitle" value="${character.notes.title}"></label>
    <div id="editNotesItemsContainer">
      <div id="editNotesItemsList">
        ${character.notes.items.map((item, index) =>
                `<div draggable="true" class="draggable">
          <input type="text" class="note-label" value="${item.label}">
          : <input type="text" class="note-value" value="${item.value}">
          <button onclick="removeNote(${index})">移除</button>
        </div>`
            ).join('')}
      </div>
      <button onclick="addNote()">新增筆記</button>
    </div>
  </div>
  <hr>
  <div>
    <h3>性格與偏好</h3>
    <div id="editPersonalityContainer">
      <div id="editPersonalityList">
        ${character.personalityPreferences.items.map((item, index) =>
                `<div draggable="true" class="draggable">
          <input type="text" class="personality-label" value="${item.label}">
          <input type="number" class="personality-value" value="${item.value}">
          <input type="text" class="personality-alt" value="${item.alternative}">
          <input type="text" class="personality-icon" value="${item.icon}">
          <button onclick="removePersonality(${index})">移除</button>
        </div>`
            ).join('')}
      </div>
      <button onclick="addPersonality()">新增性格偏好</button>
    </div>
  </div>
  <br>
  <button onclick="saveEdit()">保存修改</button>
  <button onclick="cancelEdit()">取消</button>
            `;
            // NEW: Initialize Sortable with visual feedback settings
            const sortableOptions = {
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onStart: function (evt) {
                    evt.item.style.transform = 'scale(1.05)';
                    evt.item.title = '拖動中...';
                },
                onEnd: function (evt) {
                    evt.item.style.transform = 'scale(1)';
                    evt.item.title = '';
                }
            };
            Sortable.create(document.getElementById('editAttributesList'), sortableOptions);
            Sortable.create(document.getElementById('editSkillsList'), sortableOptions);
            Sortable.create(document.getElementById('editDiceRollsList'), sortableOptions);
            Sortable.create(document.getElementById('editNotesItemsList'), sortableOptions);
            Sortable.create(document.getElementById('editPersonalityList'), sortableOptions);
        }

        // NEW: Save edit form data back into character and re-render view
        function saveEdit() {
            // Update basic info
            character.characterName = document.getElementById('editCharacterName').value;
            character.playerName = document.getElementById('editPlayerName').value;
            character.id = document.getElementById('editCharacterID').value;
            let newAvatar = document.getElementById('editAvatar').value;

            // Collect attributes and filter out if both fields are empty
            const attrElems = document.querySelectorAll('#editAttributesList > div');
            const newAttributes = Array.from(attrElems).map(div => {
                const key = div.querySelector('.attr-key').value.trim();
                const value = div.querySelector('.attr-value').value.trim();
                return { key, value };
            }).filter(item => item.key !== "" || item.value !== "");
            character.attributes.attributesList = newAttributes;

            // Collect skills and filter out if both fields are empty
            const skillElems = document.querySelectorAll('#editSkillsList > div');
            let newSkills = [];
            skillElems.forEach(div => {
                const typeVal = div.querySelector('.skill-type').value.trim();
                const valueVal = div.querySelector('.skill-value').value.trim();
                if (typeVal !== "" || valueVal !== "") {
                    newSkills.push({ type: typeVal, value: parseInt(valueVal, 10) || 0 });
                }
            });
            character.skills = newSkills;

            // Collect diceRolls and filter out if both fields are empty
            const diceElems = document.querySelectorAll('#editDiceRollsList > div');
            const newDice = Array.from(diceElems).map(div => {
                const key = div.querySelector('.dice-key').value.trim();
                const value = div.querySelector('.dice-value').value.trim();
                return { key, value };
            }).filter(item => item.key !== "" || item.value !== "");
            character.diceRolls = newDice;

            // Collect notes and filter out if both fields are empty
            character.notes.title = document.getElementById('editNotesTitle').value;
            const noteElems = document.querySelectorAll('#editNotesItemsList > div');
            const newNotes = Array.from(noteElems).map(div => {
                const label = div.querySelector('.note-label').value.trim();
                const value = div.querySelector('.note-value').value.trim();
                return { label, value };
            }).filter(item => item.label !== "" || item.value !== "");
            character.notes.items = newNotes;

            // Collect personalityPreferences and filter out if both label and alternative are empty
            const persElems = document.querySelectorAll('#editPersonalityList > div');
            const newPers = Array.from(persElems).map(div => {
                const label = div.querySelector('.personality-label').value.trim();
                const value = parseInt(div.querySelector('.personality-value').value.trim(), 10) || 0;
                const alternative = div.querySelector('.personality-alt').value.trim();
                const icon = div.querySelector('.personality-icon').value.trim();
                return { label, value, alternative, icon };
            }).filter(item => item.label !== "" || item.alternative !== "");
            character.personalityPreferences.items = newPers;

            // Update avatar image in character view, if present
            const avatarContainer = document.querySelector('.avatar-container');
            if (avatarContainer) {
                avatarContainer.innerHTML = `<img id="avatarImage" src="${newAvatar}" alt="角色頭像">`;
            }

            // Re-render original view (using your existing code)
            renderViewMode();
            isEditMode = false;
        }

        // NEW: Cancel edit and re-render view mode
        function cancelEdit() {
            renderViewMode();
            isEditMode = false;
        }

        // NEW: Helper functions for dynamic add/remove operations.
        function removeAttr(keyToRemove) {
            console.log('Removing attribute', keyToRemove);
            // Remove matching attribute by key from the edit form
            const container = document.getElementById('editAttributesList');
            container.innerHTML = Array.from(container.querySelectorAll('div'))
                .filter(div => div.querySelector('.attr-key').value.trim() !== keyToRemove)
                .map(div => div.outerHTML).join('');
        }
        // Modified addAttribute() to insert new attribute directly into the list container
        function addAttribute() {
            const attributesList = document.getElementById('editAttributesList');
            attributesList.insertAdjacentHTML('beforeend', `
              <div draggable="true" class="draggable">
                <input type="text" class="attr-key" placeholder="屬性名稱">
                : <input type="text" class="attr-value" placeholder="屬性值">
                <button onclick="this.parentElement.remove()">移除</button>
              </div>
            `);
        }
        function removeSkill(index) {
            const container = document.getElementById('editSkillsList');
            container.removeChild(container.children[index]);
        }
        function addSkill() {
            const container = document.getElementById('editSkillsList');
            container.insertAdjacentHTML('beforeend', `
              <div draggable="true" class="draggable">
                <input type="text" class="skill-type" placeholder="技能名稱">
                <input type="number" class="skill-value" placeholder="數值">
                <button onclick="this.parentElement.remove()">移除</button>
              </div>
            `);
        }
        function removeDice(keyToRemove) {
            const container = document.getElementById('editDiceRollsList');
            container.innerHTML = Array.from(container.querySelectorAll('div'))
                .filter(div => div.querySelector('.dice-key').value.trim() !== keyToRemove)
                .map(div => div.outerHTML).join('');
        }
        function addDice() {
            const container = document.getElementById('editDiceRollsList');
            container.insertAdjacentHTML('beforeend', `
              <div draggable="true" class="draggable">
                <input type="text" class="dice-key" placeholder="骰項">
                : <input type="text" class="dice-value" placeholder="數值">
                <button onclick="this.parentElement.remove()">移除</button>
              </div>
            `);
        }
        function removeNote(index) {
            const container = document.getElementById('editNotesItemsList');
            container.removeChild(container.children[index]);
        }
        function addNote() {
            const container = document.getElementById('editNotesItemsList');
            container.insertAdjacentHTML('beforeend', `
              <div draggable="true" class="draggable">
                <input type="text" class="note-label" placeholder="標籤">
                : <input type="text" class="note-value" placeholder="內容">
                <button onclick="this.parentElement.remove()">移除</button>
              </div>
            `);
        }
        function removePersonality(index) {
            const container = document.getElementById('editPersonalityList');
            container.removeChild(container.children[index]);
        }
        function addPersonality() {
            const container = document.getElementById('editPersonalityList');
            container.insertAdjacentHTML('beforeend', `
              <div draggable="true" class="draggable">
                <input type="text" class="personality-label" placeholder="名稱">
                <input type="number" class="personality-value" placeholder="數值">
                <input type="text" class="personality-alt" placeholder="對立">
                <input type="text" class="personality-icon" placeholder="圖示類名">
                <button onclick="this.parentElement.remove()">移除</button>
              </div>
            `);
        }

        // NEW: In renderViewMode, add conversion steps similarly before using map()
        function renderViewMode() {
            if (!Array.isArray(character.attributes.attributesList)) {
                character.attributes.attributesList = Object.entries(character.attributes.attributesList).map(([key, value]) => ({ key, value }));
            }
            if (!Array.isArray(character.diceRolls)) {
                character.diceRolls = Object.entries(character.diceRolls).map(([key, value]) => ({ key, value }));
            }
            const container = document.querySelector('.container');
            container.innerHTML = `
  <!-- Rebuild the view mode using updated character data -->
  <button id="editBtn" onclick="toggleEditMode()">編輯角色</button>
  <div class="grid">
      <div class="column">
          <div class="player-info">
              <h2 id="characterName">${character.characterName}</h2>
              <div class="info flex-container">
                  <span class="flex-item" id="playerName">${character.playerName}</span>
                  <span class="flex-item" id="characterID">${character.id}</span>
              </div>
          </div>
          <div class="avatar-container">
              <img id="avatarImage" src="${document.getElementById('editAvatar') ? document.getElementById('editAvatar').value : avatarImageUrl}" alt="角色頭像">
          </div>
          <h3 id="attributeTitle">${character.attributeTitle}</h3>
          <div id="basic-attributes">
              <div class="attribute-group">
                  ${character.attributes.attributesList.map(attr =>
                `<span class="attribute">${attr.key}：<span style="color: var(--text-color);">${attr.value}</span></span>`
            ).join('')}
              </div>
          </div>
      </div>
      <div class="column">
          <h3 id="skillsTitle">${character.skillsTitle}</h3>
          <canvas id="skillsChart"></canvas>
          <div class="status-bars">
              <h3>${character.personalityPreferencesTitle}</h3>
              ${character.personalityPreferences.items.map(item => `
                  <div class="status-item">
                      <i class="${item.icon} icon"></i>
                      <span>${item.label}</span>
                      <div class="progress-bar">
                          <div class="progress" style="width: ${item.value}%"></div>
                      </div>
                      <span>${item.alternative}</span>
                  </div>
              `).join('')}
          </div>
      </div>
      <div class="column">
          <h3 id="diceTitle">${character.diceTitle}</h3>
          <div id="dice-rolls">
              <!-- Fixed dice-rolls container without invalid inline style -->
              <div class="attribute-group">
                ${character.diceRolls.map(dice => `<span class="attribute">${dice.key}：<span style="color: var(--text-color);">${dice.value}</span></span>`).join('')}
              </div>
          </div>
          <div class="divider"></div>
          <div class="message">
              <h3 id="notesTitle">${character.notes.title}</h3>
              <div id="notes">
                  ${character.notes.items.map(item => `<p>${item.label}：<span style="color: var(--text-color);">${item.value}</span></p>`).join('')}
              </div>
          </div>
      </div>
  </div>
        `;
            // Re-initialize any dynamic elements like the Chart
            const ctx = document.getElementById('skillsChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: character.skills.map(skill => skill.type),
                    datasets: [{
                        data: character.skills.map(skill => skill.value),
                        backgroundColor: 'rgba(255, 105, 180, 0.3)',
                        borderColor: 'rgba(255, 105, 180, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(255, 105, 180, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { color: '#4a5568', font: { size: 12 } },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>

</html>