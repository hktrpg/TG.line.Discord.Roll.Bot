# **主題：RUN\_DESIGN 互動故事格式說明**

### **1. 概觀 (Overview)**

  * **名稱**: `RUN_DESIGN`
  * **類型**: 互動式故事的文字標記語言 (Markup Language)。
  * **主要目標**:
      * **人類可讀寫**: 格式簡潔，易於手動編輯與版本控制。
      * **機器可轉換**: 可穩定編譯成 JSON 格式，並能從 JSON 無損轉換回 `RUN_DESIGN` 文字格式。
  * **檔案編碼**: 必須為 `UTF-8`。
  * **空白與註解**:
      * 允許使用空白行以增加可讀性。
      * 以 `//` 開頭的單行文字為註解，處理時會被忽略。

-----

### **2. 頂層定義 (Top-Level Definitions)**

此區塊定義故事的全域設定與變數。

#### **2.1. 後設資料 (Metadata)**

  * **用途**: 設定故事的基本資訊，如標題和作者。

  * **語法**:

      * `[meta] title "<Title>"`: 設定故事標題。
      * `[meta] author "<Author>"`: 設定作者。此為 **必填** 欄位。
      * `[intro] <text>`: 新增一行故事的介紹文字。可使用多行 `[intro]` 來建立多段介紹。

  * **範例**:

    ```text
    // 故事基本資訊
    [meta] title "貓咪的一天"
    [meta] author "HKTRPG"

    // 故事介紹，會顯示在遊戲開始前
    [intro] 歡迎來到這個互動故事！
    [intro] 你將扮演一隻可愛的貓咪。
    ```

#### **2.2. 玩家變數 (Player Variables)**

  * **用途**: 定義遊戲開始前需要玩家輸入的變數。
  * **語法**: `[player_var] <key> "<prompt>" ["<placeholder>"]`
  * **參數**:
      * `<key>`: 變數的唯一識別字 (ID)，例如 `cat_name`。
      * `<prompt>`: 系統向玩家顯示的提問文字。
      * `["<placeholder>"]`: (可選) 輸入框中預設顯示的提示文字。
  * **範例**:
    ```text
    [player_var] cat_name "請輸入你的貓咪名字：" "例如：橘子"
    [player_var] owner_name "請輸入主人的名字：" "例如：小明"
    ```

#### **2.3. 遊戲屬性 (Game Stats)**

  * **用途**: 定義玩家的核心數值，例如力量、敏捷等。
  * **語法**: `[stat_def] <key> <min> <max> ["<label>"]`
  * **參數**:
      * `<key>`: 屬性的唯一識別字 (ID)，例如 `Cuteness`。
      * `<min>`: 屬性的最小值。
      * `<max>`: 屬性的最大值。
      * `["<label>"]`: (可選) 屬性的顯示名稱。
  * **初始化規則**:
      * 當遊戲首次開始且該屬性未被 `[set]` 指定過時，其初始值會是 `<min>` 到 `<max>` 之間的一個 **隨機整數**。
      * 一旦屬性被 `[set]` 明確賦值後，將不再被隨機初始化覆寫。
  * **範例**:
    ```text
    [stat_def] Cuteness 1 10 "萌度"
    [stat_def] Energy 1 10 "活力"
    ```

#### **2.4. 內部變數 (Internal Variables)**

  * **用途**: 定義遊戲內部使用的變數，用於追蹤狀態或條件。
  * **語法**: `[var_def] <key> <min> <max> ["<label>"]`
  * **參數**:
      * `<key>`: 變數的唯一識別字 (ID)，例如 `rain`。
      * `<min>`: 變數的最小值。
      * `<max>`: 變數的最大值。
      * `["<label>"]`: (可選) 變數的顯示名稱。
  * **初始化規則**:
      * 變數的初始值固定為其 `<min>` 值，除非被 `[set]` 覆寫。
  * **範例**:
    ```text
    [var_def] rain 0 1 "是否下雨"
    ```

-----

### **3. 頁面結構 (Page Structure)**

故事由多個頁面 (Page) 組成，玩家在頁面之間跳轉來推進劇情。

#### **3.1. 頁面定義 (Page Definition)**

  * **用途**: 宣告一個新的頁面。
  * **語法**:
      * `[label] <id>`: 定義頁面的唯一 ID。
          * **ID 限制**: 頁面 ID **只能使用數字** (例如 `0`, `1`, `100`)。
          * **起始頁面**: `[label] 0` 是固定的故事起始頁面。
      * `[title] <text>`: (可選) 設定頁面的標題。
  * **範例**:
    ```text
    [label] 0
    [title] 故事的開始
    ```

#### **3.2. 頁面內容 (Page Content)**

頁面內容由一系列指令構成，按順序執行。

  * **顯示文字**: `[text] <content>`

      * **用途**: 顯示一段文字。
      * **範例**: `[text] 天氣晴朗，是個適合冒險的日子。`

  * **條件顯示文字**:

      * **語法**:
          * `[text|if=<expr>] <content>`: 當 `<expr>` 運算式為真時，顯示文字。
          * `[text|else] <content>`: 若前一個或多個連續的 `if` 條件皆不成立，則顯示此文字。
          * `[text|ifs=<expr>] <content>`: **獨立條件顯示**。只要條件成立就顯示，不與其他 `if/else` 形成條件鏈。
      * **範例**:
        ```text
        // 條件鏈 (if/else)，只會顯示其中一個
        [text|if=Energy>=8] 你感到精力充沛！
        [text|else] 你覺得有點想睡。

        // 獨立條件 (ifs)，兩個都可能顯示
        [text|ifs=Cuteness>5] 你搖了搖尾巴，看起來很可愛。
        [text|ifs=Mischief>5] 你的眼神中閃過一絲調皮。
        ```

  * **指定說話者**: `[text|speaker=<key>] <content>`

      * **用途**: 標記該段文字的說話者。
      * **範例**: `[text|speaker=cat_name] 喵～`

  * **機率顯示**: `[random] <percent>%`

      * **用途**: 使 **緊鄰其後的下一行** `[text]` 有 `<percent>`% 的機率顯示。
      * **範例**:
        ```text
        [random] 30%
        [text] 你在路上撿到了一根貓薄荷棒！
        [text] 你繼續向前走。 // 這行不受 random 影響
        ```

  * **設定變數/屬性**: `[set]`

      * **語法**:
          * `[set] <key>=<expr>`: 無條件賦值。
          * `[set|if=<expr>] <key>=<expr>`: 條件成立時才賦值。
          * `[set|ifs=<expr>] <key>=<expr>`: 獨立條件賦值。
      * **規則**:
          * 若 `<key>` 是已定義的 `stat_def`，則寫入 `stats`。
          * 否則，寫入 `variables`。
      * **範例**:
        ```text
        // 檢定 SAN 值的流程
        [set] sancheck=1d100
        [text] 你的 SAN Check 擲骰結果是：{sancheck}
        [set|if=san<sancheck] san=san-1
        [text|if=san<sancheck] 你的 SAN 值減少了 1 點。
        ```

#### **3.3. 結局 (Ending)**

  * **用途**: 標記一個頁面為結局頁。
  * **語法**:
      * `[ending]`: 在此標籤之後的 `[text]` 行將被視為結局描述。
      * 一個檔案中必須 **至少包含一個** 有 `[ending]` 標籤的頁面。
  * **規則**:
      * 結局文字支援 `if/else` 條件鏈，系統會顯示第一個符合條件的結局文字。
  * **範例**:
    ```text
    [label] 99
    [title] 故事的終點
    [ending]
    [text|if=Cuteness>8] 因為你的可愛，你被主人原諒了，並得到了一個罐頭。
    [text|else] 你被關進了籠子裡，好好反省。
    ```

#### **3.4. 選項 (Choices)**

  * **用途**: 提供可互動的選項，讓玩家跳轉到不同頁面。
  * **語法**:
      * 以 `[choice]` 開始選項區塊。
      * 每個選項格式為: `-> <text> | <page_id> [| if=<expr>|else] [| stat=<mods>]`
  * **參數**:
      * `<text>`: 選項顯示的文字。
      * `<page_id>`: 目標頁面的 ID (必須是數字) 或特殊值 `END`。
          * `END`: 提供一個結束遊戲的按鈕。
          * **附帶加成的同頁跳轉**: 可使用 `2a`, `2b` 格式。數字 `2` 代表實際跳轉的頁面 ID，而字母 `a`, `b` 僅用於區分不同的 `stat` 加成效果。
      * `[| if=<expr>]`: (可選) 選項出現的條件。
      * `[| stat=<mods>]`: (可選) 選擇此選項後應用的屬性變更，僅支援整數加減。格式為 `stat_key+1,other_key-2`。
  * **範例**:
    ```text
    [label] 1
    [title] 早晨的抉擇
    [choice]
    // 基本選項
    -> 出去探險 | 2

    // 帶條件的選項
    -> 繼續睡覺 | 3 | if=Energy<5

    // 跳轉到同一頁面但有不同加成
    -> 展現力量！ | 10a | stat=Power+1
    -> 表現敏捷！ | 10b | stat=Agility+1

    // 結束遊戲
    -> 結束這一天 | END
    ```

  * **條件鏈 (if/else) 行為**:
    - 相鄰的多個選項若以 `if=...` 與 `else` 組成，系統只會在該鏈內選出一個顯示：第一個條件成立者；若都不成立且存在 `else`，則顯示 `else`。鏈外的其他選項獨立顯示。

    - 例 A：

      ```text
      [choice]
      -> (檢視結局...) | 101 | if=damage_done==0 && helped==0
      -> (檢視結局...) | 110 | else
      ```

    - 例 B（鏈 + 獨立選項）：

      ```text
      [choice]
      -> (檢視結局...) | 101 | if=damage_done==0 && helped==0
      -> (檢視結局...) | 110 | else
      -> (檢視結局...) | 103
      ```

-----

### **4. 運算式與特殊語法 (Expressions & Special Syntax)**

#### **4.1. 運算式 (Expressions)**

  * **用途**: 用於 `if`, `ifs`, `set` 等指令中的條件判斷與計算。
  * **語法**: 類似 JavaScript 的子集合。
  * **支援運算子**: `&&`, `||`, `!`, `<`, `<=`, `>`, `>=`, `==`, `===`, `!=`, `!==`, `+`, `-`, `*`, `/`, `%`, `()`。
  * **安全限制**:
    * 禁止任何函式呼叫。
    * 禁止使用以下識別字：`globalThis`, `global`, `process`, `this`, `Function`, `constructor`, `require`。
    * 禁止使用點號（`.`）：
      * 不可做屬性存取（如 `obj.prop`）。
      * 不可使用小數字面量（如 `1.5`）。
      * 在條件（`if=...`/`ifs=...`）中，若出現 `.`，條件一律視為不成立。
      * 在賦值（`[set] key=<expr>`）中，若出現 `.`，該值不會被計算，會以原樣字串寫入。若需字面句點，請將值用引號包起來（如：`"A.B"`）。
  * **範例**:
      * `if=Cuteness>=8 && Energy>3`
      * `if=(Power>5) && !(Agility>5)`
      * `[set] total_score=Power+Agility*2`

#### **4.2. 擲骰 (Dice Rolls)**

  * **用途**: 在遊戲中引入隨機性。
  * **格式**: `xDy` (例如 `1d6`, `2d20`)。
  * **使用場景**:
    1.  **運算式中**: `if=1d20+Agility>15` 或 `[set] damage=2d6+Power`。
    2.  **文字中 (Placeholder)**: `[text] 你擲出了 {1d100} 點。` 顯示時會直接替換為擲骰總和。

#### **4.3. 佔位符 (Placeholders)**

  * **用途**: 在 `[text]` 內容中顯示變數或屬性的值。
  * **語法**: `{key}`
  * **解析順序 (優先級由高至低)**:
    1.  `variables` (內部變數)
    2.  `stats` (遊戲屬性)
    3.  `playerVariables` (玩家變數)
  * **巢狀解析**: 佔位符支援一層巢狀解析。
  * **範例**:
    ```text
    [player_var] owner_name "主人名字"
    [set] title="最愛的"
    [set] nickname="{title}{owner_name}"
    // 假設玩家輸入 "小明"，下面這行會顯示 "暱稱：最愛的小明"
    [text] 暱稱：{nickname}
    ```

-----

### **5. 系統限制 (System Limits)**

  * **頁面數量**: 最多 400 頁。
  * **文字長度**: 每行 `[text]` 內容最多 500 字。
  * **結局頁**: 必須至少存在一個帶有 `[ending]` 標籤的頁面。
  * **頁面 ID**: **只能是數字**。
  * **檔案大小**: 匯入/更新的檔案上限約為 1 MB。